<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç–æ–≤—ã–π WS –ö–ª–∏–µ–Ω—Ç</title>
  <style>
      body { font-family: sans-serif; }
      .log-area { border: 1px solid #ccc; padding: 10px; min-height: 100px; background-color: #f9f9f9; }
      .server { color: #007bff; font-weight: bold; }
      .client { color: #28a745; }
  </style>
</head>
<body>
<h1>WebSocket –¢–µ—Å—Ç (–ö–ª–∏–µ–Ω—Ç)</h1>
<p>–°—Ç–∞—Ç—É—Å: <span id="status">–û—Ç–∫–ª—é—á–µ–Ω</span></p>

<button id="connectButton">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ws://localhost:3000/ws</button>

<hr>

<h2>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
<input type="text" id="messageInput" value="–ü—Ä–∏–≤–µ—Ç, —Å–µ—Ä–≤–µ—Ä Fastify!" style="width: 300px;">
<button id="sendButton" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<button id="getPuzzle" disabled>–î–∞–π</button>

<h3>–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π:</h3>
<div id="log" class="log-area"></div>

<script>
  const wsUrl = 'ws://localhost:3000/ws';
  let socket = null;

  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const sendButton = document.getElementById('sendButton');
  const inputEl = document.getElementById('messageInput');
  const connectButton = document.getElementById('connectButton');
  const getPuzzleButton = document.getElementById('getPuzzle');

  function log(message, type = 'server') {
    logEl.innerHTML += `<div class="${type}">${message}</div>`;
    logEl.scrollTop = logEl.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
  }

  function send(data) {
    if (socket && socket.readyState === WebSocket.OPEN) {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –∫–∞–∫ –≤—ã –æ–∂–∏–¥–∞–µ—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      const dataToSend = JSON.stringify(data);
      socket.send(dataToSend);
      log(`[–û–¢–ü–†–ê–í–õ–ï–ù–û]: ${dataToSend}`, 'client');
    } else {
      log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è".', 'client');
    }

  }

  getPuzzleButton.onclick = function() {
    send({
      type: "get-puzzle",
    });
  }

  connectButton.onclick = function() {
    if (socket && socket.readyState === WebSocket.OPEN) {
      log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ.", 'client');
      return;
    }

    // 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ WebSocket-–æ–±—ä–µ–∫—Ç–∞
    socket = new WebSocket(wsUrl);
    statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (Handshake –∑–∞–≤–µ—Ä—à–µ–Ω)
    socket.onopen = function(e) {
      statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
      sendButton.disabled = false;
      connectButton.disabled = true;
      getPuzzleButton.disabled = false;
      log('üü¢ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.', 'client');
    };

    // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    socket.onmessage = function(event) {
      const rawData = event.data;
      try {
        const parsed = JSON.parse(rawData);
        log(`[${parsed.type.toUpperCase()}]: ${parsed.data}`, 'server');
      } catch (e) {
        log(`[–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ]: ${rawData}`, 'server');
      }
    };

    // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    socket.onerror = function(error) {
      log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'server');
      statusEl.textContent = '–û—à–∏–±–∫–∞';
    };

    // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    socket.onclose = function(event) {
      statusEl.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
      sendButton.disabled = true;
      connectButton.disabled = false;
      log(`üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ö–æ–¥: ${event.code}`, 'client');
    };
  };

  // 6. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  sendButton.onclick = function() {
    const message = inputEl.value;
    send({
      type: "message",
      data: message,
    })
  };

</script>
</body>
</html>